#!/bin/bash -u
#
# Fresh 19.09.0-root (<https://github.com/wikimedia/fresh>)
#
# Usage:
#
#   you@precious.local:~/dev/oojs$ fresh
#
#   # Fresh environment!
#   nobody@76010858c836:/oojs$ â€¦
#   nobody@76010858c836:/oojs$ exit
#
# Mods:
#
# - Changes "user=nobody" to "user=root".
#   This means you can use sudo commands inside the container.
#   For example, to temporarily install packages with apt-get.
#
# This is free and unencumbered software released into the public domain.
#

scriptversion='19.09.0-root (2019-09-02)'
imagename=docker-registry.wikimedia.org/releng/node10-test-browser
imageversion=0.6.0
shortname=fresh-node10
mountpath="$PWD"
mountname=$(basename "$PWD")

# Change title of the Terminal window, and restore it afterwards
echo -e '\033]2;'"$shortname"'\007\c'
trap "echo -e '\033]2;\007'" 0 SIGTERM SIGINT

# Color codes. â€“ http://linux.101hacks.com/ps1-examples/prompt-color-using-tput/
CLR_NONE=`tput sgr0`
CLR_BOLD=`tput bold`
CLR_GREEN=`tput setaf 2`
CLR_GREY=`tput setaf 7`
welcomecmd_static="echo \"$CLR_GREY# fresh: $CLR_BOLD$scriptversion$CLR_NONE$CLR_GREY
# image: $imagename:$imageversion
# os: Debian Linux 9 (Stretch)
# software: Node.js v10.15.2 (npm 6.5.0)
#           Chromium 71.0.3578.80
#           Mozilla Firefox 60.7.0
#           JSDuck 5.3.4 (Ruby 2.3.3p222)
# mount: /$mountname âžŸ $mountpath

ðŸŒ±  ${CLR_BOLD}${CLR_GREEN}Fresh!
$CLR_NONE\""

docker run --rm --interactive --tty \
	--volume /"$PWD"://"$basename" -e 'HOME=/tmp' \
	--entrypoint /bin/sh \
	--user root \
	"$imagename:$imageversion" \
	-c "cd /$basename/;$welcomecmd_static;bash"

# # Launch Fresh faster by avoiding file reads and shell commands
# # as part of the welcome message. To update the static welcome
# # messages before a release, comment out the above, and run
# # the below portion instead.
# welcomecmd=". /etc/os-release
# echo \"$CLR_GREY# fresh: $CLR_BOLD$scriptversion$CLR_NONE$CLR_GREY
# # image: $imagename:$imageversion
# # os: \$PRETTY_NAME
# # software: Node.js \$(node --version) (npm \$(npm --version))
# #           Chromium \$(chromium --product-version)
# #           \$(firefox --version)
# #           \$(jsduck --version) \$(ruby --version)
# # mount: /$mountname âžŸ $mountpath
#
# ðŸŒ±  ${CLR_BOLD}${CLR_GREEN}Fresh!
# $CLR_NONE\""
# docker run --rm --interactive --tty \
# 	--volume /"$mountpath"://"$mountname" -e 'HOME=/tmp' \
# 	--entrypoint /bin/sh \
# 	"$imagename:$imageversion" \
# 	-c "cd /$mountname/;$welcomecmd;bash"
