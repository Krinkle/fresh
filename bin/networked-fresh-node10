#!/bin/bash -eu
#
# Fresh 19.09.0-networked (<https://github.com/wikimedia/fresh>)
#
# Usage:
#
#   you@precious.local:~/dev/oojs$ fresh
#
#   # Fresh environment!
#   nobody@76010858c836:/oojs$ â€¦
#   nobody@76010858c836:/oojs$ exit
#
# Mods:
#
# - Enable "network=host" flag.
#   This enables the container to talk to other local servers (e.g. mw-docker-dev)
#   https://docs.docker.com/network/network-tutorial-host/
#
# - Forward "MW_" and "MEDIAWIKI_" prefixed environment variables.
#   This enables npm-run scripts (such as wdio for mediawiki) to
#   discover where you have MediaWiki installed (assuming these are
#   set from a bashrc file).
#
# This is free and unencumbered software released into the public domain.
#

scriptversion='19.09.0-networked (2019-09-02)'
imagename=docker-registry.wikimedia.org/releng/node10-test-browser
imageversion=0.6.0
shortname=fresh-node10
mountpath="$PWD"
mountname=$(basename "$PWD")

envfile="$(mktemp)"
env | grep -E 'MW_|MEDIAWIKI_' > "$envfile"

# Change title of the Terminal window, and restore it afterwards
echo -e '\033]2;'"$shortname"'\007\c'
trap "rm -f \"$envfile\"; echo -e '\033]2;\007'" 0 SIGTERM SIGINT

# Color codes. â€“ http://linux.101hacks.com/ps1-examples/prompt-color-using-tput/
CLR_NONE=`tput sgr0`
CLR_BOLD=`tput bold`
CLR_GREEN=`tput setaf 2`
CLR_GREY=`tput setaf 7`
welcomecmd_static="echo \"$CLR_GREY# fresh: $CLR_BOLD$scriptversion$CLR_NONE$CLR_GREY
# image: $imagename:$imageversion
# os: Debian Linux 9 (Stretch)
# software: Node.js v10.15.2 (npm 6.5.0)
#           Chromium 71.0.3578.80
#           Mozilla Firefox 60.7.0
#           JSDuck 5.3.4 (Ruby 2.3.3p222)
# mount: /$mountname âžŸ $mountpath

ðŸŒ±  ${CLR_BOLD}${CLR_GREEN}Fresh!
$CLR_NONE\""

# https://docs.docker.com/network/network-tutorial-host/
docker run --rm --interactive --tty \
	--network host \
	--env-file "$envfile" \
	--volume /"$PWD"://"$basename" -e 'HOME=/tmp' \
	--entrypoint /bin/sh \
	"$imagename:$imageversion" \
	-c "cd /$basename/;$welcomecmd_static;bash"
